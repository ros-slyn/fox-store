{% extends 'admin/master.html' %}
{% block content %}
<div class="content-wrapper" id="app">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <!-- Order Details Modal -->
                <div class="modal fade" id="orderDetailsModal" data-backdrop="static" data-keyboard="false"
                     tabindex="-1" aria-labelledby="orderDetailsLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="orderDetailsLabel">Order Details #[[selectedOrder?.id]]</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div v-if="selectedOrder">
                                    <!-- Rest of your modal content remains the same -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Customer Information</h6>
                                            <p><strong>Name:</strong> [[selectedOrder.customer_name]]</p>
                                            <p><strong>Email:</strong> [[selectedOrder.customer_email]]</p>
                                            <p><strong>Phone:</strong> [[selectedOrder.customer_phone || 'N/A']]</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Order Information</h6>
                                            <p><strong>Date:</strong> [[selectedOrder.order_date]]</p>
                                            <p><strong>Status:</strong>
                                                <span :class="getStatusClass(selectedOrder.status)" class="badge">
                                            [[selectedOrder.status]]
                                        </span>
                                            </p>
                                            <p><strong>Payment:</strong> [[selectedOrder.payment_method]]</p>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6>Shipping Address</h6>
                                            <p>[[selectedOrder.shipping_address]], [[selectedOrder.city]],
                                                [[selectedOrder.country]]</p>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6>Order Items</h6>
                                            <table class="table table-sm">
                                                <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Price</th>
                                                    <th>Qty</th>
                                                    <th>Subtotal</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr v-for="item in selectedOrder.items" :key="item.product_name">
                                                    <td>[[item.product_name]]</td>
                                                    <td>$[[(item.product_price || 0).toFixed(2)]]</td>
                                                    <td>[[item.quantity]]</td>
                                                    <td>$[[(item.subtotal || 0).toFixed(2)]]</td>
                                                </tr>
                                                </tbody>
                                                <tfoot>
                                                <tr>
                                                    <td colspan="3" class="text-right"><strong>Shipping Fee:</strong>
                                                    </td>
                                                    <td><strong>$[[(selectedOrder.shipping_fee ||
                                                        0).toFixed(2)]]</strong></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="3" class="text-right"><strong>Total Amount:</strong>
                                                    </td>
                                                    <td><strong>$[[(selectedOrder.total_amount ||
                                                        0).toFixed(2)]]</strong></td>
                                                </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div v-else>
                                    <p class="text-center text-muted">Loading order details...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Modal -->

                <div class="col-sm-6">
                    <h1 class="m-0">Order Management</h1>
                </div>
                <div class="col-sm-6">
                    <div class="float-right">
                        <select class="form-control" v-model="statusFilter" @change="fetchOrders()"
                                style="width: 200px; display: inline-block;">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="shipping">Shipping</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-borderless table-striped">
                                <thead>
                                <tr class="bg-primary text-white">
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Email</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="order in order_list" :key="order.id">
                                    <td>#[[order.id]]</td>
                                    <td>[[order.customer_name]]</td>
                                    <td>[[order.customer_email]]</td>
                                    <td>$[[(order.total_amount || 0).toFixed(2)]]</td>
                                    <td>
                                            <span :class="getStatusClass(order.status)" class="badge">
                                                [[order.status]]
                                            </span>
                                    </td>
                                    <td>[[order.order_date]]</td>
                                    <td>[[order.item_count]] items</td>
                                    <td>
                                        <button class="btn btn-sm btn-info mr-2" @click="viewOrderDetails(order.id)">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <select class="form-control-sm"
                                                @change="updateStatus(order.id, $event.target.value)"
                                                :value="order.status">
                                            <option value="pending">Pending</option>
                                            <option value="confirmed">Confirmed</option>
                                            <option value="shipping">Shipping</option>
                                            <option value="delivered">Delivered</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr v-if="order_list.length === 0">
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-box-open fa-2x mb-2"></i><br>
                                        No orders found
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    const {createApp} = Vue
    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                order_list: [],
                selectedOrder: null,
                statusFilter: ''
            }
        },
        created() {
            this.fetchOrders()
        },
        methods: {
            getStatusClass(status) {
                const statusClasses = {
                    'pending': 'bg-warning text-dark',
                    'confirmed': 'bg-info',
                    'shipping': 'bg-primary',
                    'delivered': 'bg-success',
                    'cancelled': 'bg-danger'
                };
                return statusClasses[status] || 'bg-secondary';
            },
            fetchOrders() {
                let vm = this
                $.LoadingOverlay("show");

                let url = '/admin/order/list'
                if (this.statusFilter) {
                    url += `?status=${this.statusFilter}`
                }

                axios.get(url)
                        .then(function (response) {
                            // Check if response has error
                            if (response.data.error) {
                                console.error('Server error:', response.data.error)
                                Swal.fire({
                                    title: "Server Error",
                                    text: response.data.error,
                                    icon: "error",
                                    draggable: true
                                });
                                vm.order_list = []
                            } else {
                                vm.order_list = response.data
                            }
                            $.LoadingOverlay("hide");
                        })
                        .catch(function (error) {
                            console.log('Error fetching orders:', error);
                            $.LoadingOverlay("hide");
                            Swal.fire({
                                title: "Error",
                                text: "Failed to load orders: " + error.message,
                                icon: "error",
                                draggable: true
                            });
                        });
            },
            viewOrderDetails(orderId) {
                let vm = this
                $.LoadingOverlay("show");
                axios.get(`/admin/order/details?order_id=${orderId}`)
                        .then(function (response) {
                            if (response.data.error) {
                                Swal.fire({
                                    title: "Error",
                                    text: response.data.error,
                                    icon: "error",
                                    draggable: true
                                });
                            } else {
                                vm.selectedOrder = response.data
                                $('#orderDetailsModal').modal('show')
                            }
                            $.LoadingOverlay("hide");
                        })
                        .catch(function (error) {
                            console.log('Error fetching order details:', error);
                            $.LoadingOverlay("hide");
                            Swal.fire({
                                title: "Error",
                                text: "Failed to load order details",
                                icon: "error",
                                draggable: true
                            });
                        });
            },
            updateStatus(orderId, newStatus) {
                let vm = this
                Swal.fire({
                    title: "Update Status?",
                    text: `Change order status to ${newStatus}?`,
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, update it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.LoadingOverlay("show");
                        axios.post('/admin/order/update-status', {
                            order_id: orderId,
                            status: newStatus
                        })
                                .then(function (response) {
                                    vm.fetchOrders() // Refresh the list
                                    $.LoadingOverlay("hide");
                                    Swal.fire({
                                        title: "Success!",
                                        text: "Order status updated successfully!",
                                        icon: "success",
                                        draggable: true
                                    });
                                })
                                .catch(function (error) {
                                    console.log('Error updating order status:', error);
                                    $.LoadingOverlay("hide");
                                    Swal.fire({
                                        title: "Error!",
                                        text: "Failed to update order status",
                                        icon: "error",
                                        draggable: true
                                    });
                                });
                    }
                });
            }
        }
    }).mount('#app')
</script>
{% endblock %}